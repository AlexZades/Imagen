// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String    @id @default(uuid())
  username            String    @unique
  email               String    @unique
  passwordHash        String
  isAdmin             Boolean   @default(false)
  creditsFree         Int        @default(0) @map("credits_free")
  creditsFreeLastGrantAt DateTime?   @map("credits_free_last_grant_at")
  nsfwEnabled         Boolean   @default(false) @map("nsfw_enabled")
  avatarUrl           String?    @map("avatar_url")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")

  // Opposite relations
  images              Image[]
  likes               Like[]

  @@unique([username, email])
}

model Image {
  id                  String    @id @default(uuid())
  userId              String    @map("user_id")
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title               String
  description         String?
  promptTags          String?    @map("prompt_tags")
  contentRating       String    @default("safe") @map("content_rating")
  
  imageUrl            String    @map("image_url")
  thumbnailUrl         String?    @map("thumbnail_url")
  filename            String
  thumbnailFilename     String?    @map("thumbnail_filename")
  
  width               Int
  height              Int
  size                Int
  
  viewCount           Int        @default(0) @map("view_count")
  likeCount           Int        @default(0) @map("like_count")
  dislikeCount        Int        @default(0) @map("dislike_count")
  
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")
  
  // Character tags - EXPLICIT MAPPING to snake_case columns
  maleCharacterTags   String?    @map("male_character_tags")
  femaleCharacterTags String?    @map("female_character_tags")
  otherCharacterTags  String?    @map("other_character_tags")

  // Opposite relations
  likes               Like[]
  imageTags           ImageTag[]
  imageStyles         ImageStyle[]

  @@index([userId])
  @@index([createdAt])
  @@index([likeCount])
}

model Tag {
  id                String    @id @default(uuid())
  name              String    @unique
  
  loras             String[]   @default([])
  minStrength        Float?     @map("min_strength")
  maxStrength        Float?     @map("max_strength")
  forcedPromptTags  String?    @map("forced_prompt_tags")
  description        String?
  
  nsfw              Boolean   @default(false)
  
  // Character tags in Tag model
  maleCharacterTags   String?    @map("male_character_tags")
  femaleCharacterTags String?    @map("female_character_tags")
  otherCharacterTags  String?    @map("other_character_tags")
  
  usageCount        Int        @default(0) @map("usage_count")
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")
  
  slider            Boolean   @default(false)
  sliderLowText     String?    @map("slider_low_text")
  sliderHighText    String?    @map("slider_high_text")

  // Opposite relation
  imageTags          ImageTag[]
}

model Style {
  id             String    @id @default(uuid())
  name           String    @unique
  description     String?
  checkpointName  String?    @map("checkpoint_name")
  usageCount     Int        @default(0) @map("usage_count")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  // Opposite relation
  imageStyles        ImageStyle[]
}

model Like {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  imageId   String   @map("image_id")
  image     Image    @relation(fields: [imageId], references: [id], onDelete: Cascade)
  
  isLike    Boolean   @map("is_like")
  createdAt DateTime   @default(now()) @map("created_at")

  @@unique([userId, imageId])
  @@index([userId])
  @@index([imageId])
}

model ImageTag {
  id       String   @id @default(uuid())
  imageId  String   @map("image_id")
  image    Image    @relation(fields: [imageId], references: [id], onDelete: Cascade)
  
  tagId    String   @map("tag_id")
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  createdAt DateTime   @default(now()) @map("created_at")

  @@unique([imageId, tagId])
  @@index([imageId])
  @@index([tagId])
}

model ImageStyle {
  id       String   @id @default(uuid())
  imageId  String   @map("image_id")
  image    Image    @relation(fields: [imageId], references: [id], onDelete: Cascade)
  
  styleId  String   @map("style_id")
  style    Style    @relation(fields: [styleId], references: [id], onDelete: Cascade)
  
  createdAt DateTime   @default(now()) @map("created_at")

  @@unique([imageId, styleId])
  @@index([imageId])
  @@index([styleId])
}

model GenerationConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
}