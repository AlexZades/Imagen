// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  password       String
  isAdmin        Boolean   @default(false)
  creditsFree    Int       @default(10)
  creditsPaid    Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  images         Image[]
  likes          Like[]
  creditHistory  CreditHistory[]
}

model Image {
  id                  String    @id @default(cuid())
  title               String
  description         String?
  promptTags          String?
  imageUrl            String
  thumbnailUrl        String
  filename            String
  thumbnailFilename   String
  width               Int
  height              Int
  size                Int
  userId              String
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  tags                Tag[]
  styles              Style[]
  likes               Like[]
  likeCount           Int       @default(0)
  viewCount           Int       @default(0)
  maleCharacterTags   String?
  femaleCharacterTags String?
  otherCharacterTags  String?
  
  // Storage fields
  storageProvider     String    @default("local") // "local", "s3", etc.
  storageKey          String?   // S3 key or similar identifier
  thumbnailStorageKey String?   // S3 key for thumbnail
}

model Tag {
  id                  String    @id @default(cuid())
  name                String    @unique
  usageCount          Int       @default(0)
  images              Image[]
  loras               String[]  @default([])
  minStrength         Float?    @default(1.0)
  maxStrength         Float?    @default(1.0)
  forcedPromptTags    String?
  nsfw                Boolean   @default(false)
  maleCharacterTags   String?
  femaleCharacterTags String?
  otherCharacterTags  String?
  
  // Slider features
  description         String?
  slider              Boolean   @default(false)
  sliderLowText       String?
  sliderHighText      String?
}

model Style {
  id             String    @id @default(cuid())
  name           String    @unique
  description    String?
  checkpointName String?
  usageCount     Int       @default(0)
  images         Image[]
}

model Like {
  id        String    @id @default(cuid())
  userId    String
  imageId   String
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  image     Image     @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@unique([userId, imageId])
}

// Simple configuration for generation settings that don't fit into Tags or Styles
model GenerationConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   // JSON stringified value
  updatedAt DateTime @updatedAt
}

model CreditHistory {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount      Int      // Positive for credit/refund, negative for usage
  type        String   // "daily_reset", "purchase", "generation", "refund", "admin_grant"
  description String?
  createdAt   DateTime @default(now())
}

model AutoGenerationTest {
  id        String   @id @default(cuid())
  prompt    String
  status    String   @default("pending") // pending, processing, completed, failed
  result    String?  // JSON stringified result
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Fallback tags for auto-generation when no specific tags are found
model FallbackTag {
  id        String   @id @default(cuid())
  prompt    String   // The tag to add to the prompt
  category  String   // e.g., "quality", "negative", "style"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Simple tag definitions for regex matching
model SimpleTag {
  id          String   @id @default(cuid())
  pattern     String   // Regex pattern to match
  tag         String   // The actual tag to use
  category    String?  // Optional category grouping
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([pattern])
}

// Speech bubble detection trigger words
model SpeechBubbleTrigger {
  id        String   @id @default(cuid())
  word      String   @unique
  createdAt DateTime @default(now())
}