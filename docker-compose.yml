version: '3.8'

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    
    container_name: imagen
    
    # Run as root to avoid permission issues
    user: "0:0"
    
    # Use host network mode for TrueNAS Scale
    # Comment out the next line and uncomment 'ports' if you prefer bridge mode
    # network_mode: host
    
    # Uncomment for bridge mode (default Docker networking)
    ports:
      - "4144:4144"
    
    volumes:
      - ./uploads:/app/public/uploads

    environment:
      - NODE_ENV=production
      - PORT=4144
      - HOSTNAME=0.0.0.0
      - DATABASE_URL=postgresql://admin:7f699476032a69382c113046726fe2b6@192.168.0.17:5432/Imagen?schema=public
      - COMFYUI_API_URL=http://192.168.0.16:3000
      # - AUTO_GENERATION_SECRET=your-secret-token-here
      # - CREDITS_SYSTEM_ENABLED=true
      
      # Set to "true" to run migrations on startup
      - AUTO_MIGRATE=false
      
      # ==================== Storage Configuration ====================
      # Storage provider: 'local' (default) or 's3' (for SeaweedFS/MinIO/AWS S3)
      - STORAGE_PROVIDER=s3
      
      # S3-Compatible Storage Configuration (required when STORAGE_PROVIDER=s3)
      # Uncomment and configure these for SeaweedFS or other S3-compatible storage
      - S3_ENDPOINT=http://192.168.0.17:30203
      - S3_REGION=tokyo  
      - S3_ACCESS_KEY_ID=admin
      - S3_SECRET_ACCESS_KEY=key
      - S3_BUCKET_NAME=imagen
      - S3_PUBLIC_URL=http://192.168.0.17:30203/imagen
      - S3_FORCE_PATH_STYLE=true
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4144"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==================== Optional: SeaweedFS Service ====================
  # Uncomment this section to run SeaweedFS locally for S3-compatible storage
  # 
  # seaweedfs:
  #   image: chrislusf/seaweedfs:latest
  #   container_name: pixelvault-seaweedfs
  #   ports:
  #     - "9333:9333"   # Master server
  #     - "8333:8333"   # S3 API
  #     - "8080:8080"   # Volume server
  #   command: "server -s3 -dir=/data"
  #   volumes:
  #     - seaweedfs_data:/data
  #   restart: unless-stopped

# volumes:
#   seaweedfs_data: